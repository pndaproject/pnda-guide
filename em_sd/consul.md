# Consul Basis

In a PNDA cluster, each nodes include a Consul agent, and for pico flavor, a server is available in the kafka instance and for the standard flavor, there is a Consul quorum on the zookeeper nodes.
Consul is then listening on port 8500. If you want to get the list of agents, you will need to specify the -http-addr parameter as Consul is not listening on 127.0.0.1 by default. 
Here is an example of the members command for a pico cluster:

```
[ec2-user@pnda-guide-14371-bastion ~]$ consul members -http-addr 10.0.0.205:8500
Node                           Address          Status  Type    Build  Protocol  DC   Segment
pnda-guide-14371-kafka-0       10.0.1.98:8301   alive   server  1.0.3  2         dc1  <all>
pnda-guide-14371-bastion       10.0.0.205:8301  alive   client  1.0.3  2         dc1  <default>
pnda-guide-14371-hadoop-dn-0   10.0.1.110:8301  alive   client  1.0.3  2         dc1  <default>
pnda-guide-14371-hadoop-edge   10.0.1.187:8301  alive   client  1.0.3  2         dc1  <default>
```

The base configuration file for Consul is located /etc/consul.d/config.json which is automatically generated by SaltStack. THe key elements of the configuration are the datacenter & domain, which will be used for DNS. We are defining also the right IP to listen to with the parameter bind_addr and client_addr. 
Here is a sample configuration file:

```
[root@pnda-guide-14371-bastion ec2-user]# cat /etc/consul.d/config.json 
{
  "bind_addr": "10.0.0.205",
  "client_addr": "10.0.0.205",
  "data_dir": "/var/consul",
  "datacenter": "dc1",
  "domain": "pnda.local",
  "enable_debug": false,
  "enable_script_checks": true,
  "encrypt": "",
  "log_level": "info",
  "ports": [
    {
      "dns": 53
    }
  ],
  "retry_interval": "30s",
  "retry_join": [
    "10.0.1.98"
  ],
  "server": false,
  "ui": true
}
```

As you can see, each agent is configured with a UI so you can access it using port 8500.
Here is a example of the Consul UI:
![Consul UI](consul_services.jpeg)

You can also have service description using JSON file. There are in /etc/consul.d, as for example, here is the zookeeper service definition:

```
[root@pnda-guide-14371-kafka-0 ec2-user]# cat /etc/consul.d/zookeeper.json 
{
    "service": {
        "id": "zookeeper0",
        "name": "zookeeper",
        "tags": ["0"],
        "address": "10.0.1.98",
        "port": 2181
    },
    "check": {
        "id": "service:zookeeper0",
        "name": "Zookeeper health check",
        "ServiceID": "zookeeper0",
        "args": ["/opt/pnda/zookeeper-3.4.11/consul_check.sh"],
        "interval": "60s",
        "timeout": "3s"
    }
}
```